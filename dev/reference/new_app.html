<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Create a new web application — new_app • webfakes</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Create a new web application — new_app" />
<meta property="og:description" content="Create a new web application" />


<meta name="robots" content="noindex">

<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">webfakes</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="In-development version">1.1.1.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../articles/introduction.html">Intro</a>
</li>
<li>
  <a href="../articles/how-to.html">How-to</a>
</li>
<li>
  <a href="../articles/glossary.html">Glossary</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../httpbin.html">The builtin httpbin app's API</a>
    </li>
    <li>
      <a href="../articles/internals.html">Webfakes internals</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/r-lib/webfakes/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Create a new web application</h1>
    <small class="dont-index">Source: <a href='https://github.com/r-lib/webfakes/blob/master/R/app.R'><code>R/app.R</code></a></small>
    <div class="hidden name"><code>new_app.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Create a new web application</p>
    </div>

    <pre class="usage"><span class='fu'>new_app</span><span class='op'>(</span><span class='op'>)</span></pre>


    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>A new <code>webfakes_app</code>.</p>
    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>The typical workflow of creating a web application is:</p><ol>
<li><p>Create a <code>webfakes_app</code> object with <code>new_app()</code>.</p></li>
<li><p>Add middleware and/or routes to it.</p></li>
<li><p>Start is with the <code>webfakes_app$listen()</code> method, or start it in
another process with <code><a href='new_app_process.html'>new_app_process()</a></code>.</p></li>
<li><p>Make queries to the web app.</p></li>
<li><p>Stop it via <code>CTRL+C</code> / <code>ESC</code>, or, if it is running in another
process, with the <code>$stop()</code> method of <code><a href='new_app_process.html'>new_app_process()</a></code>.</p></li>
</ol>

<p>A web application can be</p><ul>
<li><p>restarted,</p></li>
<li><p>saved to disk,</p></li>
<li><p>copied to another process using the callr package, or a similar way,</p></li>
<li><p>embedded into a package,</p></li>
<li><p>extended by simply adding new routes and/or middleware.</p></li>
</ul>

<p>The webfakes API is very much influenced by the
<a href='http://expressjs.com/'>express.js</a> project.</p><h3 class='hasAnchor' id='arguments'><a class='anchor' href='#arguments'></a>Create web app objects</h3>
<p><div class="r"></p><pre><span class='fu'>new_app</span><span class='op'>(</span><span class='op'>)</span>
</pre><p></div></p>
<p><code>new_app()</code> returns a <code>webfakes_app</code> object the has the methods listed
on this page.</p>
<p>An app is an environment with S3 class <code>webfakes_app</code>.</p>

<h3 class='hasAnchor' id='arguments'><a class='anchor' href='#arguments'></a>The handler stack</h3>


<p>An app has a stack of handlers. Each handler can be a route or
middleware. The differences between the two are:</p><ul>
<li><p>A route is bound to one or more paths on the web server. Middleware
is not (currently) bound to paths, but run for all paths.</p></li>
<li><p>A route is usually (but not always) the end of the handler stack for
a request. I.e. a route takes care of sending out the response to
the request. Middleware typically performs some action on the request
or the response, and then the next handler in the stack is invoked.</p></li>
</ul>


<h3 class='hasAnchor' id='arguments'><a class='anchor' href='#arguments'></a>Routes</h3>


<p>The following methods define routes. Each method corresponds to the
HTTP verb with the same name, except for <code>app$all()</code>, which creates a
route for all HTTP methods.<div class="r"></p><pre>app$all(path, ...)
app$delete(path, ...)
app$get(path, ...)
app$head(path, ...)
app$patch(path, ...)
app$post(path, ...)
app$put(path, ...)
... (see list below)
</pre><p></div></p><ul>
<li><p><code>path</code> is a path specification, see 'Path specification' below.</p></li>
<li><p><code>...</code> is one or more handler functions. These will be placed in the
handler stack, and called if they match an incoming HTTP request.
See 'Handler functions' below.</p></li>
</ul>

<p>webfakes also has methods for the less frequently used HTTP verbs:
<code>CONNECT</code>, <code>MKCOL</code>, <code>OPTIONS</code>, <code>PROPFIND</code>, <code>REPORT</code>. (The method
names are always in lowercase.)</p>
<p>If a request is not handled by any routes (or handler functions in
general), then webfakes will send a simple HTTP 404 response.</p>

<h3 class='hasAnchor' id='arguments'><a class='anchor' href='#arguments'></a>Middleware</h3>


<p><code>app$use()</code> adds a middleware to the handler stack. A middleware is
a handler function, see 'Handler functions' below. webfakes comes with
middleware to perform common tasks:</p><ul>
<li><p><code><a href='mw_etag.html'>mw_etag()</a></code> adds an <code>Etag</code> header to the response.</p></li>
<li><p><code><a href='mw_log.html'>mw_log()</a></code> logs each requests to standard output, or another connection.</p></li>
<li><p><code><a href='mw_raw.html'>mw_raw()</a></code> parses raw request bodies.</p></li>
<li><p><code><a href='mw_text.html'>mw_text()</a></code> parses plain text request bodies.</p></li>
<li><p><code><a href='mw_json.html'>mw_json()</a></code> parses JSON request bodies.</p></li>
<li><p><code><a href='mw_multipart.html'>mw_multipart()</a></code> parses multipart request bodies.</p></li>
<li><p><code><a href='mw_static.html'>mw_static()</a></code> serves static files from a directory.</p></li>
<li><p><code><a href='mw_urlencoded.html'>mw_urlencoded()</a></code> parses URL encoded request bodies.</p></li>
</ul><p><div class="r"></p><pre><span class='va'>app</span><span class='op'>$</span><span class='fu'>use</span><span class='op'>(</span><span class='va'>...</span>, .first <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span>
</pre><p></div></p><ul>
<li><p><code>...</code> is a set of (middleware) handler functions. They are added to
the handler stack, and called for every HTTP request. (Unless an HTTP
response is created before reaching this point in the handler stack.)</p></li>
<li><p><code>.first</code> set to <code>TRUE</code> is you want to add the handler function
to the bottom of the stack.</p></li>
</ul>


<h3 class='hasAnchor' id='arguments'><a class='anchor' href='#arguments'></a>Handler functions</h3>


<p>A handler function is a route or middleware. A handler function is
called by webfakes with the incoming HTTP request and the outgoing
HTTP response objects (being built) as arguments. The handler function
may query and modify the members of the request and/or the response
object. If it returns the string <code>"next"</code>, then it is <em>not</em> a terminal
handler, and once it returns, webfakes will move on to call the next
handler in the stack.</p>
<p>A typical route:<div class="r"></p><pre><span class='va'>app</span><span class='op'>$</span><span class='fu'>get</span><span class='op'>(</span><span class='st'>"/user/:id"</span>, <span class='kw'>function</span><span class='op'>(</span><span class='va'>req</span>, <span class='va'>res</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='va'>id</span> <span class='op'>&lt;-</span> <span class='va'>req</span><span class='op'>$</span><span class='va'>params</span><span class='op'>$</span><span class='va'>id</span>
  <span class='va'>...</span>
  <span class='va'>res</span><span class='op'>$</span>
    <span class='fu'>set_status</span><span class='op'>(</span><span class='fl'>200L</span><span class='op'>)</span><span class='op'>$</span>
    <span class='fu'>set_header</span><span class='op'>(</span><span class='st'>"X-Custom-Header"</span>, <span class='st'>"foobar"</span><span class='op'>)</span><span class='op'>$</span>
    <span class='fu'>send_json</span><span class='op'>(</span><span class='va'>response</span>, auto_unbox <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span>
<span class='op'>}</span><span class='op'>)</span>
</pre><p></div></p><ul>
<li><p>The handler belongs to an API path, which is a wildcard path in
this case. It matches <code>/user/alice</code>, <code>/user/bob</code>, etc. The handler
will be only called for GET methods and matching API paths.</p></li>
<li><p>The handler receives the request (<code>req</code>) and the response (<code>res</code>).</p></li>
<li><p>It sets the HTTP status, additional headers, and sends the data.
(In this case the <code>webfakes_response$send_json()</code> method automatically
converts <code>response</code> to JSON and sets the <code>Content-Type</code> and
<code>Content-Length</code> headers.</p></li>
<li><p>This is a terminal handler, because it does <em>not</em> return <code>"next"</code>.
Once this handler function returns, webfakes will send out the HTTP
response.</p></li>
</ul>

<p>A typical middleware:<div class="r"></p><pre><span class='va'>app</span><span class='op'>$</span><span class='fu'>use</span><span class='op'>(</span><span class='kw'>function</span><span class='op'>(</span><span class='va'>req</span>, <span class='va'>res</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='va'>...</span>
  <span class='st'>"next"</span>
<span class='op'>}</span><span class='op'>)</span>
</pre><p></div></p><ul>
<li><p>There is no HTTP method and API path here, webfakes will call the
handler for each HTTP request.</p></li>
<li><p>This is not a terminal handler, it does return <code>"next"</code>, so after it
returns webfakes will look for the next handler in the stack.</p></li>
</ul>


<h3 class='hasAnchor' id='arguments'><a class='anchor' href='#arguments'></a>Errors</h3>


<p>If a handler function throws an error, then the web server will return
a HTTP 500 <code>text/plain</code> response, with the error message as the
response body.</p>

<h3 class='hasAnchor' id='arguments'><a class='anchor' href='#arguments'></a>Request and response objects</h3>


<p>See <a href='webfakes_request.html'>webfakes_request</a> and <a href='webfakes_response.html'>webfakes_response</a> for the methods of the
request and response objects.</p>

<h3 class='hasAnchor' id='arguments'><a class='anchor' href='#arguments'></a>Path specification</h3>


<p>Routes are associated with one or more API paths. A path specification
can be</p><ul>
<li><p>A "plain" (i.e. without parameters) string. (E.g. <code>"/list"</code>.)</p></li>
<li><p>A parameterized string. (E.g. <code>"/user/:id"</code>.)</p></li>
<li><p>A regular expression created via <code><a href='new_regexp.html'>new_regexp()</a></code> function.</p></li>
<li><p>A list or character vector of the previous ones. (Regular expressions
must be in a list.)</p></li>
</ul>


<h3 class='hasAnchor' id='arguments'><a class='anchor' href='#arguments'></a>Path parameters</h3>


<p>Paths that are specified as parameterized strings or regular expressions
can have parameters.</p>
<p>For parameterized strings the keys may contain letters, numbers and
underscores. When webfakes matches an API path to a handler with a
parameterized string path, the parameters will be added to the
request, as <code>params</code>. I.e. in the handler function (and subsequent
handler functions, if the current one is not terminal), they are
available in the <code>req$params</code> list.</p>
<p>For regular expressions, capture groups are also added as parameters.
It is best to use named capture groups, so that the parameters are in
a named list.</p>
<p>If the path of the handler is a list of parameterized strings or
regular expressions, the parameters are set according to the first
matching one.</p>

<h3 class='hasAnchor' id='arguments'><a class='anchor' href='#arguments'></a>Templates</h3>


<p>webfakes supports templates, using any template engine. It comes with
a template engine that uses the glue package, see <code><a href='tmpl_glue.html'>tmpl_glue()</a></code>.</p>
<p><code>app$engine()</code> registers a template engine, for a certain file
extension. The <code>$render()</code> method of <a href='webfakes_response.html'>webfakes_response</a>
can be called from the handler function to evaluate a template from a
file.<div class="r"></p><pre><span class='va'>app</span><span class='op'>$</span><span class='fu'>engine</span><span class='op'>(</span><span class='va'>ext</span>, <span class='va'>engine</span><span class='op'>)</span>
</pre><p></div></p><ul>
<li><p><code>ext</code>: the file extension for which the template engine is added.
It should not contain the dot. E.g. <code>"html"', </code>"brew"`.</p></li>
<li><p><code>engine</code>: the template engine, a function that takes the file path
(<code>path</code>) of the template, and a list of local variables (<code>locals</code>)
that can be used in the template. It should return the result.</p></li>
</ul>

<p>An example template engine that uses glue might look like this:<div class="r"></p><pre><span class='va'>app</span><span class='op'>$</span><span class='fu'>engine</span><span class='op'>(</span><span class='st'>"txt"</span>, <span class='kw'>function</span><span class='op'>(</span><span class='va'>path</span>, <span class='va'>locals</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='va'>txt</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/readChar.html'>readChar</a></span><span class='op'>(</span><span class='va'>path</span>, nchars <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/file.info.html'>file.size</a></span><span class='op'>(</span><span class='va'>path</span><span class='op'>)</span>, useBytes <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span>
  <span class='fu'>glue</span><span class='fu'>::</span><span class='fu'><a href='https://glue.tidyverse.org/reference/glue.html'>glue_data</a></span><span class='op'>(</span><span class='va'>locals</span>, <span class='va'>txt</span><span class='op'>)</span>
<span class='op'>}</span><span class='op'>)</span>
</pre><p></div></p>
<p>(The built-in <code><a href='tmpl_glue.html'>tmpl_glue()</a></code> engine has more features.)</p>
<p>This template engine can be used in a handler:<div class="r"></p><pre><span class='va'>app</span><span class='op'>$</span><span class='fu'>get</span><span class='op'>(</span><span class='st'>"/view"</span>, <span class='kw'>function</span><span class='op'>(</span><span class='va'>req</span>, <span class='va'>res</span><span class='op'>)</span> <span class='op'>{</span>
 <span class='va'>txt</span> <span class='op'>&lt;-</span> <span class='va'>res</span><span class='op'>$</span><span class='fu'>render</span><span class='op'>(</span><span class='st'>"test"</span><span class='op'>)</span>
 <span class='va'>res</span><span class='op'>$</span>
   <span class='fu'>set_type</span><span class='op'>(</span><span class='st'>"text/plain"</span><span class='op'>)</span><span class='op'>$</span>
   <span class='fu'>send</span><span class='op'>(</span><span class='va'>txt</span><span class='op'>)</span>
<span class='op'>}</span><span class='op'>)</span>
</pre><p></div></p>
<p>The location of the templates can be set using the <code>views</code> configuration
parameter, see the <code>$set_config()</code> method below.</p>
<p>In the template, the variables passed in as <code>locals</code>, and also the
response local variables (see <code>locals</code> in <a href='webfakes_response.html'>webfakes_response</a>), are
available.</p>

<h3 class='hasAnchor' id='arguments'><a class='anchor' href='#arguments'></a>Starting and stopping</h3>
<p><div class="r"></p><pre><span class='va'>app</span><span class='op'>$</span><span class='fu'>listen</span><span class='op'>(</span>port <span class='op'>=</span> <span class='cn'>NULL</span>, opts <span class='op'>=</span> <span class='fu'><a href='server_opts.html'>server_opts</a></span><span class='op'>(</span><span class='op'>)</span>, cleanup <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span>
</pre><p></div></p><ul>
<li><p><code>port</code>: port to listen on. When <code>NULL</code>, the operating system will
automatically select a free port.</p></li>
<li><p><code>opts</code>: options to the web server. See <code><a href='server_opts.html'>server_opts()</a></code> for the
list of options and their default values.</p></li>
<li><p><code>cleanup</code>: stop the server (with an error) if the standard input
of the process is closed. This is handy when the app runs in a
<code><a href='https://rdrr.io/pkg/callr/man/r_session.html'>callr::r_session</a></code> subprocess, because it stops the app (and the
subprocess) if the main process has terminated.</p></li>
</ul>

<p>This method does not return, and can be interrupted with <code>CTRL+C</code> / <code>ESC</code>
or a SIGINT signal. See <code><a href='new_app_process.html'>new_app_process()</a></code> for interrupting an app that
is running in another process.</p>
<p>When <code>port</code> is <code>NULL</code>, the operating system chooses a port where the
app will listen. To be able to get the port number programmatically,
before the listen method blocks, it advertises the selected port in a
<code>webfakes_port</code> condition, so one can catch it:</p>
<p>webfakes by default binds only to the loopback interface at 127.0.0.1, so
the webfakes web app is never reachable from the network.<div class="r"></p><pre><span class='fu'><a href='https://rdrr.io/r/base/conditions.html'>withCallingHandlers</a></span><span class='op'>(</span>
  <span class='va'>app</span><span class='op'>$</span><span class='fu'>listen</span><span class='op'>(</span><span class='op'>)</span>,
  <span class='st'>"webfakes_port"</span> <span class='op'>=</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>msg</span><span class='op'>)</span> <span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span><span class='va'>msg</span><span class='op'>$</span><span class='va'>port</span><span class='op'>)</span>
<span class='op'>)</span>
</pre><p></div></p>

<h3 class='hasAnchor' id='arguments'><a class='anchor' href='#arguments'></a>Logging</h3>


<p>webfakes can write an access log that contains an entry for all incoming
requests, and also an error log for the errors that happen while
the server is running. This is the default behavior for local app
(the ones started by <code>app$listen()</code> and for remote apps (the ones
started via <code><a href='new_app_process.html'>new_app_process()</a></code>:</p><ul>
<li><p>Local apps do not write an access log by default.</p></li>
<li><p>Remote apps write an access log into the
<code>&lt;tmpdir&gt;/webfakes/&lt;pid&gt;/access.log</code> file, where <code>&lt;tmpdir&gt;</code> is the
session temporary directory of the <em>main process</em>, and <code>&lt;pid&gt;</code> is
the process id of the <em>subprocess</em>.</p></li>
<li><p>Local apps write an error log to <code>&lt;tmpdir&gt;/webfakes/error.log</code>, where
<code>&lt;tmpdir&gt;</code> is the session temporary directory of the current process.</p></li>
<li><p>Remote app write an error log to the <code>&lt;tmpdir&gt;/webfakes/&lt;pid&gt;/error.log</code>,
where <code>&lt;tmpdir&gt;</code> is the session temporary directory of the
<em>main process</em> and <code>&lt;pid&gt;</code> is the process id of the <em>subprocess</em>`.</p></li>
</ul>

<p>See <code><a href='server_opts.html'>server_opts()</a></code> for changing the default logging behavior.</p>

<h3 class='hasAnchor' id='arguments'><a class='anchor' href='#arguments'></a>Shared app data</h3>
<p><div class="r"></p><pre><span class='va'>app</span><span class='op'>$</span><span class='va'>locals</span>
</pre><p></div></p>
<p>It is often useful to share data between handlers and requests in an
app. <code>app$locals</code> is an environment that supports this. E.g. a
middleware that counts the number of requests can be implemented as:</p><pre><span class='va'>app</span><span class='op'>$</span><span class='fu'>use</span><span class='op'>(</span><span class='kw'>function</span><span class='op'>(</span><span class='va'>req</span>, <span class='va'>res</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='va'>locals</span> <span class='op'>&lt;-</span> <span class='va'>req</span><span class='op'>$</span><span class='va'>app</span><span class='op'>$</span><span class='va'>locals</span>
  <span class='kw'>if</span> <span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/NULL.html'>is.null</a></span><span class='op'>(</span><span class='va'>locals</span><span class='op'>$</span><span class='va'>num</span><span class='op'>)</span><span class='op'>)</span> <span class='va'>locals</span><span class='op'>$</span><span class='va'>num</span> <span class='op'>&lt;-</span> <span class='fl'>0L</span>
  <span class='va'>locals</span><span class='op'>$</span><span class='va'>num</span> <span class='op'>&lt;-</span> <span class='va'>locals</span><span class='op'>$</span><span class='va'>num</span> <span class='op'>+</span> <span class='fl'>1L</span>
  <span class='st'>"next"</span>
<span class='op'>}</span><span class='op'>)</span>
</pre>

<p><a href='webfakes_response.html'>webfakes_response</a> objects also have a <code>locals</code> environment, that is
initially populated as a copy of <code>app$locals</code>.</p>

<h3 class='hasAnchor' id='arguments'><a class='anchor' href='#arguments'></a>Configuration</h3>
<p><div class="r"></p><pre><span class='va'>app</span><span class='op'>$</span><span class='fu'>get_config</span><span class='op'>(</span><span class='va'>key</span><span class='op'>)</span>
<span class='va'>app</span><span class='op'>$</span><span class='fu'>set_config</span><span class='op'>(</span><span class='va'>key</span>, <span class='va'>value</span><span class='op'>)</span>
</pre><p></div></p><ul>
<li><p><code>key</code>: configuration key.</p></li>
<li><p><code>value</code>: configuration value.</p></li>
</ul>

<p>Currently used configuration values:</p><ul>
<li><p><code>views</code>: path where webfakes searches for templates.</p></li>
</ul>


    <h2 class="hasAnchor" id="see-also"><a class="anchor" href="#see-also"></a>See also</h2>

    <div class='dont-index'><p><a href='webfakes_request.html'>webfakes_request</a> for request objects, <a href='webfakes_response.html'>webfakes_response</a> for
response objects.</p></div>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='co'># see example web apps in the `/examples` directory in</span>
<span class='fu'><a href='https://rdrr.io/r/base/system.file.html'>system.file</a></span><span class='op'>(</span>package <span class='op'>=</span> <span class='st'>"webfakes"</span>, <span class='st'>"examples"</span><span class='op'>)</span>
</div><div class='output co'>#&gt; [1] "/Users/runner/work/_temp/Library/webfakes/examples"</div><div class='input'>
<span class='va'>app</span> <span class='op'>&lt;-</span> <span class='fu'>new_app</span><span class='op'>(</span><span class='op'>)</span>
<span class='va'>app</span><span class='op'>$</span><span class='fu'>use</span><span class='op'>(</span><span class='fu'><a href='mw_log.html'>mw_log</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>

<span class='va'>app</span><span class='op'>$</span><span class='fu'>get</span><span class='op'>(</span><span class='st'>"/hello"</span>, <span class='kw'>function</span><span class='op'>(</span><span class='va'>req</span>, <span class='va'>res</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='va'>res</span><span class='op'>$</span><span class='fu'>send</span><span class='op'>(</span><span class='st'>"Hello there!"</span><span class='op'>)</span>
<span class='op'>}</span><span class='op'>)</span>

<span class='va'>app</span><span class='op'>$</span><span class='fu'>get</span><span class='op'>(</span><span class='fu'><a href='new_regexp.html'>new_regexp</a></span><span class='op'>(</span><span class='st'>"^/hi(/.*)?$"</span><span class='op'>)</span>, <span class='kw'>function</span><span class='op'>(</span><span class='va'>req</span>, <span class='va'>res</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='va'>res</span><span class='op'>$</span><span class='fu'>send</span><span class='op'>(</span><span class='st'>"Hi indeed!"</span><span class='op'>)</span>
<span class='op'>}</span><span class='op'>)</span>

<span class='va'>app</span><span class='op'>$</span><span class='fu'>post</span><span class='op'>(</span><span class='st'>"/hello"</span>, <span class='kw'>function</span><span class='op'>(</span><span class='va'>req</span>, <span class='va'>res</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='va'>res</span><span class='op'>$</span><span class='fu'>send</span><span class='op'>(</span><span class='st'>"Got it, thanks!"</span><span class='op'>)</span>
<span class='op'>}</span><span class='op'>)</span>

<span class='va'>app</span>
</div><div class='output co'>#&gt; &lt;webfakes_app&gt;
#&gt; routes:
#&gt;   use *
#&gt;   get /hello
#&gt;   get &lt;webfakes_regexp&gt; "^/hi(/.*)?$"
#&gt;   post /hello
#&gt; fields and methods:
#&gt;   all(path, ...)         # add route for *all* HTTP methods
#&gt;   delete(path, ...)      # add route for DELETE
#&gt;   engine(ext, engine)    # add template engine for file extension
#&gt;   head(path, ...)        # add route for HEAD
#&gt;   listen(port)           # start web app on port
#&gt;   patch(path, ...)       # add route for PATCH
#&gt;   post(path, ...)        # add route for POST
#&gt;   put(path, ...)         # add route for PUT
#&gt;   use(...)               # add middleware
#&gt;   locals                 # app-wide shared data
#&gt; # see ?webfakes_app for all methods</div><div class='input'>
<span class='co'># Start the app with: app$listen()</span>
<span class='co'># Or start it in another R session: new_app_process(app)</span>
</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by <a href='https://github.com/gaborcsardi'>Gábor Csárdi</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.9000.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


